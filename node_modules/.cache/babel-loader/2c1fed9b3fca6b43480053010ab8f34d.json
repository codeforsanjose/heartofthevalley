{"ast":null,"code":"import { whichButtons, getOffsetPosition } from './event-utils';\nconst DEFAULT_OPTIONS = {\n  srcElement: 'root',\n  priority: 0\n};\nexport default class EventRegistrar {\n  constructor(eventManager) {\n    /**\n     * Handles hammerjs event\n     */\n    this.handleEvent = event => {\n      if (this.isEmpty()) {\n        return;\n      }\n\n      const mjolnirEvent = this._normalizeEvent(event);\n\n      let target = event.srcEvent.target;\n\n      while (target && target !== mjolnirEvent.rootElement) {\n        this._emit(mjolnirEvent, target);\n\n        if (mjolnirEvent.handled) {\n          return;\n        }\n\n        target = target.parentNode;\n      }\n\n      this._emit(mjolnirEvent, 'root');\n    };\n\n    this.eventManager = eventManager;\n    this.handlers = []; // Element -> handler map\n\n    this.handlersByElement = new Map();\n    this._active = false;\n  } // Returns true if there are no non-passive handlers\n\n\n  isEmpty() {\n    return !this._active;\n  }\n\n  add(type, handler, options) {\n    let once = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : false;\n    let passive = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : false;\n    const {\n      handlers,\n      handlersByElement\n    } = this;\n    let opts = DEFAULT_OPTIONS;\n\n    if (typeof options === 'string' || options && options.addEventListener) {\n      // is DOM element, backward compatibility\n      // @ts-ignore\n      opts = { ...DEFAULT_OPTIONS,\n        srcElement: options\n      };\n    } else if (options) {\n      opts = { ...DEFAULT_OPTIONS,\n        ...options\n      };\n    }\n\n    let entries = handlersByElement.get(opts.srcElement);\n\n    if (!entries) {\n      entries = [];\n      handlersByElement.set(opts.srcElement, entries);\n    }\n\n    const entry = {\n      type,\n      handler,\n      srcElement: opts.srcElement,\n      priority: opts.priority\n    };\n\n    if (once) {\n      entry.once = true;\n    }\n\n    if (passive) {\n      entry.passive = true;\n    }\n\n    handlers.push(entry);\n    this._active = this._active || !entry.passive; // Sort handlers by descending priority\n    // Handlers with the same priority are excuted in the order of registration\n\n    let insertPosition = entries.length - 1;\n\n    while (insertPosition >= 0) {\n      if (entries[insertPosition].priority >= entry.priority) {\n        break;\n      }\n\n      insertPosition--;\n    }\n\n    entries.splice(insertPosition + 1, 0, entry);\n  }\n\n  remove(type, handler) {\n    const {\n      handlers,\n      handlersByElement\n    } = this;\n\n    for (let i = handlers.length - 1; i >= 0; i--) {\n      const entry = handlers[i];\n\n      if (entry.type === type && entry.handler === handler) {\n        handlers.splice(i, 1);\n        const entries = handlersByElement.get(entry.srcElement);\n        entries.splice(entries.indexOf(entry), 1);\n\n        if (entries.length === 0) {\n          handlersByElement.delete(entry.srcElement);\n        }\n      }\n    }\n\n    this._active = handlers.some(entry => !entry.passive);\n  }\n  /**\n   * Invoke handlers on a particular element\n   */\n\n\n  _emit(event, srcElement) {\n    const entries = this.handlersByElement.get(srcElement);\n\n    if (entries) {\n      let immediatePropagationStopped = false; // Prevents the current event from bubbling up\n\n      const stopPropagation = () => {\n        event.handled = true;\n      }; // Prevent any remaining listeners from being called\n\n\n      const stopImmediatePropagation = () => {\n        event.handled = true;\n        immediatePropagationStopped = true;\n      };\n\n      const entriesToRemove = [];\n\n      for (let i = 0; i < entries.length; i++) {\n        const {\n          type,\n          handler,\n          once\n        } = entries[i];\n        handler({ ...event,\n          // @ts-ignore\n          type,\n          stopPropagation,\n          stopImmediatePropagation\n        });\n\n        if (once) {\n          entriesToRemove.push(entries[i]);\n        }\n\n        if (immediatePropagationStopped) {\n          break;\n        }\n      }\n\n      for (let i = 0; i < entriesToRemove.length; i++) {\n        const {\n          type,\n          handler\n        } = entriesToRemove[i];\n        this.remove(type, handler);\n      }\n    }\n  }\n  /**\n   * Normalizes hammerjs and custom events to have predictable fields.\n   */\n\n\n  _normalizeEvent(event) {\n    const rootElement = this.eventManager.getElement();\n    return { ...event,\n      ...whichButtons(event),\n      ...getOffsetPosition(event, rootElement),\n      preventDefault: () => {\n        event.srcEvent.preventDefault();\n      },\n      stopImmediatePropagation: null,\n      stopPropagation: null,\n      handled: false,\n      rootElement\n    };\n  }\n\n}","map":{"version":3,"mappings":"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","names":["whichButtons","getOffsetPosition","DEFAULT_OPTIONS","srcElement","priority","EventRegistrar","constructor","eventManager","event","isEmpty","mjolnirEvent","_normalizeEvent","target","srcEvent","rootElement","_emit","handled","parentNode","handlers","handlersByElement","Map","_active","add","type","handler","options","once","passive","opts","addEventListener","entries","get","set","entry","push","insertPosition","length","splice","remove","i","indexOf","delete","some","immediatePropagationStopped","stopPropagation","stopImmediatePropagation","entriesToRemove","getElement","preventDefault"],"sourceRoot":"","sources":["../../../src/utils/event-registrar.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}